In this section, we describe our recommended approach
\citep{HoImaKin05}, which uses
\hlink{Zelig}{http://gking.harvard.edu/zelig/} to conduct parametric
causal inference after preprocessing the data through \MatchIt.  (The
resulting matched data sets can also be exported to other statistical
programs using commands such as {\tt write.csv()} and {\tt
  write.table()} for ASCII files, and {\tt write.dta} in {\tt foreign}
package for a STATA binary file.)  Zelig \citep{ImaKinLau04} is an
easy-to-use R package that implements a large variety of statistical
models, gives easily interpretable results by simulating quantities of
interest, provides numerical and graphical summaries, and is easily
extensible.  The package along with the complete documentation is
available at
\hlink{http://gking.harvard.edu/zelig/}{http://gking.harvard.edu/zelig/}.
\MatchIt\ and Zelig can be easily used together to enable estimation
of causal effects in very general settings with a variety of
statistical models.

The general syntax is as follows. First, we use \texttt{match.data()}
to create the matched data by excluding unmatched units from the
original data, and including information about the particular matching
procedure (i.e., weights, subclasses, and the distance measure).
\begin{Schunk}
\begin{Sinput}
> m.data <- match.data(m.out)
\end{Sinput}
\end{Schunk}
where {\tt m.out} is the \MatchIt\ object from {\tt matchit()} and
{\tt m.data} is the resulting matched data.  Next, we analyze the
matched data set via the following command,
\begin{Schunk}
\begin{Sinput}
> z.out <- zelig(Y ~ treat + x1 + x2, model = mymodel, data = m.data)
\end{Sinput}
\end{Schunk}
where {\tt Y} is the outcome variable, {\tt mymodel} is the selected
model, and {\tt z.out} is the output object from {\tt zelig}.

To illustrate this approach, we provide two detailed examples using
the Lalonde data. Users can run these example commands by typing {\tt
  demo(Zelig)} at the R prompt. Although we use the linear least
squares model in these examples, a wide range of other models are
available in Zelig (for the list of supported models, see
\hlink{http://gking.harvard.edu/zelig/docs/Models\_Zelig\_Can.html}{http://gking.harvard.edu/zelig/docs/Models_Zelig_Can.html}).
If you have not installed Zelig, follow the installation procedure
described at
\hlink{http://gking.harvard.edu/zelig/docs/Installation.html}{http://gking.harvard.edu/zelig/docs/Installation.html}
To load the Zelig package after installing it, type

\begin{Schunk}
\begin{Sinput}
> library(Zelig)
\end{Sinput}
\end{Schunk}

\paragraph{Examples}
\begin{enumerate}
\item We begin our first example by conducting the nearest neighbor
  matching using the estimated propensity score from the logistic
  regression
\begin{Schunk}
\begin{Sinput}
> m.out1 <- matchit(treat ~ age + educ + black + hispan + nodegree + 
+     married + re74 + re75, method = "nearest", data = lalonde)
\end{Sinput}
\end{Schunk}
Note that we skip an important step of checking balance in this
example in order to focus on the illustration of analyzing matched
data sets. We then fit the linear model to the control group
controlling for the estimated propensity score and other covariates,
\begin{Schunk}
\begin{Sinput}
> z.out1 <- zelig(re78 ~ age + educ + black + hispan + nodegree + 
+     married + re74 + re75 + distance, data = match.data(m.out1, 
+     "control"), model = "ls")
\end{Sinput}
\end{Schunk}
where {\tt "control"} option in {\tt match.data()} extracts the
matched control units and {\tt ls} specifies linear regression. Note
that we need not include the treatment indicator in this regression.
Next, we set the covariates to the covariates of matched treated units
and use conditional prediction by setting {\tt cond = TRUE} and {\tt
  fn = NULL} option in {\tt setx()} command in order to impute the
counterfactual outcome for the treated units. {\tt sim()} command in
Zelig does the imputation.
\begin{Schunk}
\begin{Sinput}
> x.out1 <- setx(z.out1, data = match.data(m.out1, "treat"), fn = NULL, 
+     cond = TRUE)
> s.out1 <- sim(z.out1, x = x.out1)
\end{Sinput}
\end{Schunk}
Finally, we obtain a summary of the results by 
\begin{Schunk}
\begin{Sinput}
> summary(s.out1)
\end{Sinput}
\begin{Soutput}

  Model: ls 
  Number of simulations: 1000 

Mean Values of Observed Data (n = 185) 
(Intercept)         age        educ       black      hispan    nodegree 
  1.000e+00   2.582e+01   1.035e+01   8.432e-01   5.946e-02   7.081e-01 
    married        re74        re75    distance 
  1.892e-01   2.096e+03   1.532e+03   5.774e-01 

Pooled Expected Values: E(Y|X)
  mean     sd   2.5%  97.5% 
4988.4 2264.7  785.4 9974.8 

Pooled Average Treatment Effect: Y - EV
  mean     sd   2.5%  97.5% 
1360.7  598.9  244.7 2538.7 

\end{Soutput}
\end{Schunk}
The results indicate that the estimated average treatment effect on
the treated is 
\$1360.7,
with a 95\% interval of
(\$245,
\$2538.7).

It is also possible to estimate the average treatment effects on both
the treated and the control groups. To do this, we fit the linear
model to the {\it treatment group} controlling for propensity score
and other covariates,
\begin{Schunk}
\begin{Sinput}
> z.out2 <- zelig(re78 ~ age + educ + black + hispan + nodegree + 
+     married + re74 + re75 + distance, data = match.data(m.out1, 
+     "treat"), model = "ls")
\end{Sinput}
\end{Schunk}
We then conduct the same simulation procedure in order to impute the
counterfactual outcome for the {\it control group},
\begin{Schunk}
\begin{Sinput}
> x.out2 <- setx(z.out2, data = match.data(m.out1, "control"), 
+     fn = NULL, cond = TRUE)
> s.out2 <- sim(z.out2, x = x.out2)
\end{Sinput}
\end{Schunk}
Finally, note that Zelig calculates the difference between observed
and either predicted or expected values.  This means that the
treatment effect for the control units is actually the effect of
control (observed control outcome minus the imputed outcome under
treatment from the model).  Hence, to combine treatment effects just
reverse the signs of the estimated treatment effect of controls.
\begin{Schunk}
\begin{Sinput}
> ate.all <- c(s.out1$qi$ate.ev, -s.out2$qi$ate.ev)
\end{Sinput}
\end{Schunk}
The point estimate and its standard error is given by
\begin{Schunk}
\begin{Sinput}
> mean(ate.all)
\end{Sinput}
\begin{Soutput}
[1] 1607

\end{Soutput}
\begin{Sinput}
> sd(ate.all)
\end{Sinput}
\begin{Soutput}
[1] 787

\end{Soutput}
\end{Schunk}
The 95\% confidence interval is given by
\begin{Schunk}
\begin{Sinput}
> quantile(ate.all, c(0.025, 0.975))
\end{Sinput}
\begin{Soutput}
 2.5% 97.5% 
  132  3262 

\end{Soutput}
\end{Schunk}
  
\item Our second example is subclassification. In this case, the
  average treatment effect estimates are obtained for each subclass
  separately as well as for the overall sample.  Estimating the
  treatment effects separately for each subclass, and then aggregating
  across subclasses, can significantly increase the robustness of the
  ultimate results since the parametric analysis within each subclass
  requires only local rather than global assumptions.

  We begin this example by conducting subclassification with four subclasses,
\begin{Schunk}
\begin{Sinput}
> m.out2 <- matchit(treat ~ age + educ + black + hispan + nodegree + 
+     married + re74 + re75, data = lalonde, method = "subclass", 
+     subclass = 4)
\end{Sinput}
\end{Schunk}
Here, we skip the important step of checking balance in order to focus
on the illustration of analyzing subclassified data sets.  Next, we
fit the linear regression within each subclass by controlling for the
estimated propensity score and past income variables within each
subclass using {\tt by} option in the {\tt zelig()} command. 
\begin{Schunk}
\begin{Sinput}
> z.out3 <- zelig(re78 ~ re74 + re75 + distance, data = match.data(m.out2, 
+     "control"), model = "ls", by = "subclass")
\end{Sinput}
\end{Schunk}
The same set of commands as the one in the first example are used to
do the imputation of the counterfactual outcomes for the treated
units.
\begin{Schunk}
\begin{Sinput}
> x.out3 <- setx(z.out3, data = match.data(m.out2, "treat"), fn = NULL, 
+     cond = TRUE)
> s.out3 <- sim(z.out3, x = x.out3)
\end{Sinput}
\end{Schunk}
Finally, to obtain the overall result, type
\begin{Schunk}
\begin{Sinput}
> summary(s.out3)
\end{Sinput}
\begin{Soutput}

  Model: ls 
  Number of simulations: 250 

Mean Values of Observed Data (n = 46) 
(Intercept)        re74        re75    distance 
     1.0000   5430.5389   2929.0394      0.2392 

Pooled Expected Values: E(Y|X)
 mean    sd  2.5% 97.5% 
 4401  5396 -6000 15831 

Pooled Average Treatment Effect: Y - EV
 mean    sd  2.5% 97.5% 
 1948  1746 -1043  5866 

\end{Soutput}
\end{Schunk}
The results indicate that the estimated average treatment effect on
the treated is
\$1948.1,
with a 95\% interval of
(\$-1042.8,
\$5865.6).
It is also possible to get the summary result for each subclass. For
example, the following command summarizes the result for the second
subclass.
\begin{Schunk}
\begin{Sinput}
> summary(s.out3, subset = 2)
\end{Sinput}
\begin{Soutput}

Results for 1 

  Model: ls 
  Number of simulations: 250 

Mean Values of Observed Data (n = 45) 
(Intercept)        re74        re75    distance 
     1.0000   1777.4221    972.3441      0.6039 

Pooled Expected Values: E(Y|X)
  mean     sd   2.5%  97.5% 
3781.1 2571.1 -989.8 9578.7 

Pooled Average Treatment Effect: Y - EV
  mean     sd   2.5%  97.5% 
2705.2 1180.7  682.3 4859.4 


\end{Soutput}
\end{Schunk}
  
\end{enumerate}


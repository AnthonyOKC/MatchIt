\section{Conducting Analyses after Matching}
\label{sec:analysis}

In this section, we describe our recommended approach
\citep{HoImaKin05}, which uses
\hlink{Zelig}{http://gking.harvard.edu/zelig/} to conduct parametric
causal inference after preprocessing the data using \MatchIt.  (The
resulting matched data sets can also be exported to other statistical
programs using commands such as {\tt write.csv()} and {\tt
  write.table()} for ASCII files, and {\tt write.dta()} in {\tt
  foreign} package for a STATA binary file.)  Zelig
\citep{ImaKinLau04} is an easy-to-use R package that implements a
large variety of statistical models, gives easily interpretable
results by simulating quantities of interest, provides numerical and
graphical summaries, and is easily extensible.  The package along with
the complete documentation is available at
\hlink{http://gking.harvard.edu/zelig/}{http://gking.harvard.edu/zelig/}.
\MatchIt\ and Zelig can be easily used together to enable estimation
of causal effects in very general settings with a variety of
statistical models.

\subsection{Quick Overview}

The general syntax is as follows. First, we use \texttt{match.data()}
to create the matched data by excluding unmatched units from the
original data, and including information about the particular matching
procedure (i.e., weights, subclasses, and the distance measure).
\begin{verbatim}
> m.data <- match.data(m.out)
\end{verbatim}
where {\tt m.out} is the \MatchIt\ object from {\tt matchit()} and
{\tt m.data} is the resulting matched data.  Next, we analyze the
matched data set via the following command,
\begin{verbatim}
> z.out <- zelig(Y ~ treat + x1 + x2, model = mymodel, data = m.data)
\end{verbatim}

where {\tt Y} is the outcome variable, {\tt mymodel} is the selected
model, and {\tt z.out} is the output object from {\tt zelig}.

\subsection{Examples}

To illustrate this approach, we provide two detailed examples using
the Lalonde data. Users can run these example commands by typing {\tt
  demo(analysis)} at the R prompt. Although we use the linear least
squares model in these examples, a wide range of other models are
available in Zelig (for the list of supported models, see
\hlink{http://gking.harvard.edu/zelig/docs/Models\_Zelig\_Can.html}{http://gking.harvard.edu/zelig/docs/Models_Zelig_Can.html}).
If you have not installed Zelig, follow the installation procedure
described at
\hlink{http://gking.harvard.edu/zelig/docs/Installation.html}{http://gking.harvard.edu/zelig/docs/Installation.html}

%One causal effect of interest is the impact of participation in the
%job training program on real earnings in 1978, for those individuals
%that participated in the program.  The average treatment effect on the
%treated (ATT) is defined as,
%\begin{align}
%  \label{att}
%  \text{ATT} & = \frac{1}{\sum_{i=1}^n t_i}\sum_{i:t_i=1} E[Y_i(1) - Y_i(0)],
%\end{align}
%where $Y_i(1)$ represents the potential outcome under the treatment of
%the job program, and $Y_i(0)$ is the potential outcome under control.
%Note that the first term inside the expectation (the right hand side
%of Equation~\ref{att}) is \emph{observed}, whereas the second term is
%the \emph{unobserved} counterfactual of real earnings if participants
%had not participated.  The nature of causal inference is that one of
%the two terms in the difference will always be unobserved.

To load the Zelig package after installing it, type
\begin{verbatim}
> library(Zelig)
\end{verbatim}

\begin{enumerate}
\item We begin our first example by conducting nearest neighbor
  matching using the estimated propensity score from the logistic
  regression
\begin{verbatim}
> m.out1 <- matchit(treat ~ age + educ + black + hispan + nodegree + 
                    married + re74 + re75, method = "nearest", data = lalonde)
\end{verbatim}
  Note that we skip an important step of checking balance in this
  example in order to focus on the illustration of analyzing matched
  data sets. We then fit the linear model to the control group
  controlling for the estimated propensity score and other covariates,
\begin{verbatim}
> z.out1 <- zelig(re78 ~ age + educ + black + hispan + nodegree + 
                  married + re74 + re75, data = match.data(m.out1, "control"), 
                  model = "ls")
\end{verbatim}
  where the {\tt "control"} option in {\tt match.data()} extracts the
  matched control units and {\tt ls} specifies linear regression. Note
  that we need not include the treatment indicator in this regression.
  Next, we set the covariates to the covariate values of the matched
  treated units and use conditional prediction by setting the {\tt
    setx()} command optionsn to {\tt cond = TRUE} and {\tt fn = NULL}
  in order to impute the counterfactual outcomes for the treated
  units. The {\tt sim()} command in Zelig does the imputation.
\begin{verbatim}
> x.out1 <- setx(z.out1, data = match.data(m.out1, "treat"), fn = NULL, 
                 cond = TRUE)
> s.out1 <- sim(z.out1, x = x.out1)
\end{verbatim}
Finally, we obtain a summary of the results by 
\begin{verbatim}
> summary(s.out1)
\end{verbatim}

\item It is also possible to estimate the average treatment effects on
  both the treated and the control groups. To do this, we fit the
  linear model to the {\it treatment group} controlling for the
  propensity score ({\tt distance}) and other covariates,

\begin{verbatim}
> z.out2 <- zelig(re78 ~ age + educ + black + hispan + nodegree + 
                  married + re74 + re75, data = match.data(m.out1, "treat"), 
                  model = "ls")
\end{verbatim}
We then conduct the same simulation procedure in order to impute the
counterfactual outcome for the {\it control group},
\begin{verbatim}
> x.out2 <- setx(z.out2, data = match.data(m.out1, "control"), fn = NULL, 
                 cond = TRUE)
> s.out2 <- sim(z.out2, x = x.out2)
\end{verbatim}
Finally, note that Zelig calculates the difference between observed
and either predicted or expected values.  This means that the
treatment effect for the control units is actually the effect of
control (observed control outcome minus the imputed outcome under
treatment from the model).  Hence, to combine treatment effects just
reverse the signs of the estimated treatment effect of controls.
\begin{verbatim}
> ate.all <- c(s.out1$qi$ate.ev, -s.out2$qi$ate.ev)
\end{verbatim}
The point estimate, its standard error, and the $95\%$ confidence
interval is given by
\begin{verbatim}
> mean(ate.all)
> sd(ate.all)
> quantile(ate.all, c(0.025, 0.975))
\end{verbatim}
  
\item Our third example is subclassification. In this case, the
  average treatment effect estimates are obtained separately for each
  subclass as well as for the overall sample.  Estimating the
  treatment effects separately for each subclass, and then aggregating
  across subclasses, can significantly increase the robustness of the
  ultimate results since the parametric analysis within each subclass
  requires only local rather than global assumptions.  

  We begin this example by conducting subclassification with four
  subclasses,
\begin{verbatim}
> m.out2 <- matchit(treat ~ age + educ + black + hispan + nodegree + 
                    married + re74 + re75, data = lalonde, 
                    method = "subclass", subclass = 4)
\end{verbatim}
  Here, we skip the important step of checking balance in order to
  focus on the illustration of analyzing subclassified data sets.
  Next, we fit the linear regression within each subclass by
  controlling for the estimated propensity score and past income
  variables within each subclass by using the {\tt by} option in the
  {\tt zelig()} command.
\begin{verbatim}
> z.out3 <- zelig(re78 ~ re74 + re75 + distance, 
                  data = match.data(m.out2, "control"), 
                  model = "ls", by = "subclass")
\end{verbatim}
  The same set of commands as in the first example are used to do the
  imputation of the counterfactual outcomes for the treated units.
\begin{verbatim}
> x.out3 <- setx(z.out3, data = match.data(m.out2, "treat"), fn = NULL, 
                 cond = TRUE)
> s.out3 <- sim(z.out3, x = x.out3)
\end{verbatim}
Finally, to obtain the overall results, type
\begin{verbatim}
> summary(s.out3)
\end{verbatim}
It is also possible to get the summary result for each subclass. For
example, the following command summarizes the result for the second
subclass.
\begin{verbatim}
> summary(s.out3, subset = 2)
\end{verbatim}
  
\end{enumerate}


%%% Local Variables: 
%%% mode: latex
%%% TeX-master: "matchit"
%%% End: 

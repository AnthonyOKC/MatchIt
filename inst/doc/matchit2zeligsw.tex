%** {\bf Does all the neyman stuff go in here, or just the examples, with
%   syntax somewhere else?}

To illustrate this approach, we provide several examples using the
Lalonde data. Users can run these example commands by typing {\tt
  demo(Zelig)} at the R prompt. We use the linear least squares model
in these examples. However, a wide range of other models are available
in Zelig (for the list of supported models, see
\hlink{http://gking.harvard.edu/zelig/docs/Models\_Zelig\_Can.html}{http://gking.harvard.edu/zelig/docs/Models_Zelig_Can.html}),
and they can be used in the exactly same way. If you have not
installed Zelig, follow the installation procedure described at
\hlink{http://gking.harvard.edu/zelig/docs/Installation.html}{http://gking.harvard.edu/zelig/docs/Installation.html}

\begin{enumerate}
\item Nearest neighbor matching using propensity scores: 

\begin{Schunk}
\begin{Sinput}
> data(lalonde)
> library(Zelig)
> m.out1 <- matchit(treat ~ age + educ + black + hispan + nodegree + 
+     married + re74 + re75, method = "nearest", data = lalonde)
> z.out1 <- zelig(re78 ~ age + educ + black + hispan + nodegree + 
+     married + re74 + re75 + distance, data = match.data(m.out1, 
+     "control"), model = "ls")
> x.out1 <- setx(z.out1, data = match.data(m.out1, "treat"), fn = NULL, 
+     cond = TRUE)
> s.out1 <- sim(z.out1, x = x.out1)
> summary(s.out1)
\end{Sinput}
\begin{Soutput}

  Model: ls 
  Number of simulations: 1000 

Mean Values of Observed Data (n = 185) 
(Intercept)         age        educ       black      hispan    nodegree 
  1.000e+00   2.582e+01   1.035e+01   8.432e-01   5.946e-02   7.081e-01 
    married        re74        re75    distance 
  1.892e-01   2.096e+03   1.532e+03   5.774e-01 

Pooled Expected Values: E(Y|X)
   mean      sd    2.5%   97.5% 
 5005.4  2292.0   732.9 10074.8 

Pooled Average Treatment Effect: Y - EV
  mean     sd   2.5%  97.5% 
1343.7  584.2  186.7 2504.9 

\end{Soutput}
\end{Schunk}
  
The estimated average treatment effect on the treated is thus 
\$1343.73, 
with a 95\% interval
of (\$186.72, 
\$2504.88).

\item Estimating the average treatment effects on both the treated and
  the control groups. We use the same {\tt matchit()} output as in the
  first example above.

\begin{Schunk}
\begin{Sinput}
> z.out2 <- zelig(re78 ~ age + educ + black + hispan + nodegree + 
+     married + re74 + re75 + distance, data = match.data(m.out1, 
+     "control"), model = "ls")
> x.out2 <- setx(z.out2, data = match.data(m.out1, "control"), 
+     fn = NULL, cond = TRUE)
> s.out2 <- sim(z.out2, x = x.out2)
> ate.all <- c(s.out1$qi$ate.ev, -s.out2$qi$ate.ev)
> mean(ate.all)
\end{Sinput}
\begin{Soutput}
[1] 666.2

\end{Soutput}
\begin{Sinput}
> sd(ate.all)
\end{Sinput}
\begin{Soutput}
[1] 850.6

\end{Soutput}
\begin{Sinput}
> quantile(ate.all, c(0.025, 0.975))
\end{Sinput}
\begin{Soutput}
  2.5%  97.5% 
-705.3 2303.7 

\end{Soutput}
\end{Schunk}
  
\item Subclassification: In this case, the average treatment effect
  estimates are obtained for each subclass separately as well as
  for the overall sample.  Estimating the treatment effects separately 
  for each subclass, and then aggregating across subclasses, can significantly
  increase the robustness of the ultimate results since the paramatric analysis
  within each subclass requires only local rather than global assumptions.

\begin{Schunk}
\begin{Sinput}
> m.out2 <- matchit(treat ~ age + educ + black + hispan + nodegree + 
+     married + re74 + re75, data = lalonde, method = "subclass", 
+     subclass = 4)
> z.out3 <- zelig(re78 ~ re74 + re75 + distance, data = match.data(m.out2, 
+     "control"), model = "ls", by = "subclass")
> x.out3 <- setx(z.out3, data = match.data(m.out2, "treat"), fn = NULL, 
+     cond = TRUE)
> s.out3 <- sim(z.out3, x = x.out3, num = 100)
> summary(s.out3)
\end{Sinput}
\begin{Soutput}

  Model: ls 
  Number of simulations: 25 

Mean Values of Observed Data (n = 46) 
(Intercept)        re74        re75    distance 
     1.0000   5430.5389   2929.0394      0.2392 

Pooled Expected Values: E(Y|X)
 mean    sd  2.5% 97.5% 
 4244  5775 -7629 16451 

Pooled Average Treatment Effect: Y - EV
  mean     sd   2.5%  97.5% 
2100.7 1873.4 -850.5 6640.1 

\end{Soutput}
\begin{Sinput}
> summary(s.out3, subset = 1)
\end{Sinput}
\begin{Soutput}

Results for 1 

  Model: ls 
  Number of simulations: 25 

Mean Values of Observed Data (n = 46) 
(Intercept)        re74        re75    distance 
     1.0000   5430.5389   2929.0394      0.2392 

Pooled Expected Values: E(Y|X)
 mean    sd  2.5% 97.5% 
 6865  3843  2975 17015 

Pooled Average Treatment Effect: Y - EV
  mean     sd   2.5%  97.5% 
 327.1  463.0 -441.6 1215.3 


\end{Soutput}
\begin{Sinput}
> summary(s.out3, subset = 2)
\end{Sinput}
\begin{Soutput}

Results for 1 

  Model: ls 
  Number of simulations: 25 

Mean Values of Observed Data (n = 45) 
(Intercept)        re74        re75    distance 
     1.0000   1777.4221    972.3441      0.6039 

Pooled Expected Values: E(Y|X)
  mean     sd   2.5%  97.5% 
3876.0 2250.0 -603.5 8807.3 

Pooled Average Treatment Effect: Y - EV
  mean     sd   2.5%  97.5% 
2610.3 1067.6  652.9 4642.0 


\end{Soutput}
\begin{Sinput}
> summary(s.out3, subset = 3)
\end{Sinput}
\begin{Soutput}

Results for 1 

  Model: ls 
  Number of simulations: 25 

Mean Values of Observed Data (n = 47) 
(Intercept)        re74        re75    distance 
     1.0000    939.9688   1217.4546      0.6934 

Pooled Expected Values: E(Y|X)
 mean    sd  2.5% 97.5% 
 3708  4410  -569  9341 

Pooled Average Treatment Effect: Y - EV
 mean    sd  2.5% 97.5% 
 2186   923   526  3822 


\end{Soutput}
\end{Schunk}
  
%\item Analysis of data from full matching: It will generally not be
%  possible to run models separately within each subclass after full
%  matching, due to very small sample sizes of either the treated or
%  control group within each subclass.  In this situation, a common
%  approach is to run a model with fixed effects included for each of
%  the subclasses.
%
%For example, 
%\begin{verbatim}
%> foo1 <- matchit(treat ~ age + educ + black + hispan + married +
%                nodegree + re74 + re75, data=lalonde, full=T)
%> m1 <- lm(re78~ treat + age + educ + black + hispan + married +
%         nodegree + re74 + re75 + as.factor(psclass),
%         data=foo1$data)
%> summary(m1)
%\end{verbatim} 
\end{enumerate}

%%% Local Variables: 
%%% mode: latex
%%% TeX-master: "matchit"
%%% End: 

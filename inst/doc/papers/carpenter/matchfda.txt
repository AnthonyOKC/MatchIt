# August 5, 2004
# Play with FDA matching to see if can do better.

fdafull <- read.table("~/matchit/docs/papers/carpenter/ajps2002-full1b.txt", header=T)
fdafull$treat <- fdafull$demsnmaj

library(Matchit)
mout <- matchit(treat ~ orderent + stafcder + prevgenx + lethal +
                deathrt1 + hosp01 + I(hospdisc/1000000) +
                hhosleng + femdiz01 + mandiz01 + peddiz01 + acutediz +
                orphdum + natreg + I(natregsq/1000) +  wpnoavg3 +
                sqrt(wpnoavg3) + vandavg3 + condavg3, data=fdafull,
                discard=1)
                                                                                                                                                             
print(summary(mout))
#mdata <- match.data(mout)
                                                                                                                                                             
mout2 <- matchit(treat ~ orderent + stafcder + prevgenx + lethal +
                deathrt1 + hosp01 + I(hospdisc/1000000) +
                hhosleng + femdiz01 + mandiz01 + peddiz01 + acutediz +
                orphdum + natreg + I(natregsq/1000) +  wpnoavg3 +
                sqrt(wpnoavg3) + vandavg3 + condavg3, data=fdafull,
                discard=1,  caliper=.25)
                                                                                                                                                             
print(summary(mout2))



#################################################################################
for (i in 1:1) {
break
# Program to try matching with the FDA data
# full1b does not have the fsubmits variable

fdafull <- read.table("~/match/docs/papers/carpenter/ajps2002-full1b.txt", header=T)

# With this model (demhsmaj, main effects), only ~7 variables have reductions in bias after matching
# Also, more treated than control so end up using all controls and just discard some treated

# For demhsmaj, no overlap in stafcder variable between dem and republican control
# For prespart, very little overlap in stafcder variable
# (Models won't run with stafcder in)

# Much better with demsnmaj as the treatment.  End up with N=326 after matching (163 treated, some controls
# get discarded).  Plots look better, and with main effects 13 of the variables  have bias reduction. stafcder
# can even be included, and things look good.

# Model 1
fdafull$treat <- fdafull$demsnmaj

# End up with 163 T, 163 C
# Slightly better if use discard==1 (161  T, 161 C)
# Not as good if use replace=T
temp3 <- matchit(treat ~ prevgenx + lethal + deathrt1 + acutediz + 
hosp01 + hospdisc + hhosleng + femdiz01 + mandiz01 + peddiz01 + orphdum + natreg + natregsq + vandavg3 + wpnoavg3 + 
condavg3 + orderent + stafcder, data=fdafull, subclass=5, discard=1)

print("1-1 nearest neighbor, demsnmaj=1 as treat, 5 subclasses")
print(temp3$sum.all[1:19,])
print(temp3$sum.matched[1:19,])

print("Covariates significant in >= 2 blocks")
print(temp3$q.table[apply(abs(temp3$q.table[,4,])>2, 1, sum, na.rm=T) >= 2,4,])

a2 <- zelig(Surv(acttime, d) ~ pscore, data=match.data(temp3, "control"), model="lognorm")

set2 <- setx(a2, data = match.data(temp3, "treat"), cond = TRUE)

sim2 <- sim(a2, x = set2, cond.data=match.data(temp3, "treat"))

print(summary(sim2))


# Try different definition of treatment # End up with 40 T, 40 C. # Balance pretty good before matching, still good after matching

fdafull$treat <- fdafull$demhsmaj*fdafull$demsnmaj*fdafull$prespart

print("NEW TREATMENT DEFINITION: UNITED/DIVIDED GOVERNMENT")

temp3 <- matchit(treat ~ prevgenx + lethal + deathrt1 + acutediz + 
hosp01 + hospdisc + hhosleng + femdiz01 + mandiz01 + peddiz01 + orphdum + natreg + natregsq + vandavg3 + wpnoavg3 + 
condavg3 + orderent + stafcder, data=fdafull, subclass=5)

temp <- matchit(treat ~ prevgenx + lethal + deathrt1 + acutediz + 
hosp01 + hospdisc + hhosleng + femdiz01 + mandiz01 + peddiz01 + orphdum + natreg + natregsq + vandavg3 + wpnoavg3 + 
condavg3 + orderent + stafcder, data=fdafull, ratio=1)

print("1-1 nearest neighbor")
print(temp$sum.all[1:19,])
print(temp$sum.matched[1:19,])

print("Covariates significant in >= 2 blocks")
print(temp$q.table[apply(abs(temp$q.table[,4,])>2, 1, sum, na.rm=T) >= 2,4,])

a2 <- zelig(Surv(acttime, d) ~ treat + pscore, data=match.data(temp, "control"), model="lognorm")

set2 <- setx(a2, data = match.data(temp, "treat"), cond = TRUE)

sim2 <- sim(a2, x = set2, cond.data=match.data(temp, "treat"))

print(summary(sim2))


}
